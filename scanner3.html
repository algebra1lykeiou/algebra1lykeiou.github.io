<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        #qrScanner {max-width:500px; margin:0 auto;}
        #startBtn {background:#007bff; color:white; border:none; padding:10px 20px; cursor:pointer;}
        #stopBtn {background:#dc3545; color:white; border:none; padding:10px 20px; cursor:pointer; display:none;}
        #cameraPreview {width:100%; height:300px; background:#000; display:none; position:relative;}
        #cameraPreview.active {display:block;}
        #cameraPreview video {width:100%; height:100%;}
        #result {background:#f0f8ff; padding:15px; margin-top:10px; display:none;}
        #result.active {display:block;}
        .scanner-line {position:absolute; top:50%; left:10%; width:80%; height:2px; background:#0f0; animation:scan 2s infinite;}
        @keyframes scan {0% {top:10%;} 50% {top:90%;} 100% {top:10%;}}
    </style>
</head>
<body>
    <div id="qrScanner">
        <button id="startBtn">Scan QR Code</button>
        <button id="stopBtn">Stop</button>
        <div id="status"></div>
        <div id="cameraPreview">
            <video id="video" autoplay playsinline></video>
            <div class="scanner-line"></div>
        </div>
        <div id="result">Scanned: <span id="scannedData"></span></div>
    </div>

    <script>
        let stream = null, scanning = false;
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const camera = document.getElementById('cameraPreview');
        const video = document.getElementById('video');
        const result = document.getElementById('result');
        const scannedData = document.getElementById('scannedData');
        const status = document.getElementById('status');
        
        startBtn.onclick = async () => {
            try {
                status.textContent = "Requesting camera...";
                stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}});
                video.srcObject = stream;
                camera.classList.add('active');
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
                status.textContent = "Point at QR code";
                
                scanning = true;
                scan();
            } catch(e) {
                status.textContent = "Camera error: " + e.message;
                demoScan();
            }
        };
        
        stopBtn.onclick = () => {
            if(stream) stream.getTracks().forEach(track => track.stop());
            camera.classList.remove('active');
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            scanning = false;
        };
        
        function scan() {
            if(!scanning) return;
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            
            if(code) {
                scannedData.textContent = code.data;
                result.classList.add('active');
                status.textContent = "QR Code scanned!";
                stopBtn.click();
                return;
            }
            
            requestAnimationFrame(scan);
        }
        
        function demoScan() {
            camera.classList.add('active');
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            status.textContent = "Demo: Scanning...";
            
            setTimeout(() => {
                scannedData.textContent = "https://example.com/demo-scan";
                result.classList.add('active');
                status.textContent = "Demo QR scanned!";
                stopBtn.click();
            }, 2000);
        }
    </script>
</body>
</html>
